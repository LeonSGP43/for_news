name: Deploy to Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd ${{ secrets.PROJECT_PATH }}
            
            # 拉取最新代码
            git pull origin main
            
            # 停止旧容器
            docker stop news-monitor || true
            docker rm news-monitor || true
            
            # 构建新镜像
            docker build -t news-monitor:latest .
            
            # 运行新容器
            docker run -d \
              --name news-monitor \
              --restart unless-stopped \
              -p 3111:3111 \
              -e NODE_ENV=production \
              -e DB_HOST=${{ secrets.DB_HOST }} \
              -e DB_PORT=3306 \
              -e DB_USER=${{ secrets.DB_USER }} \
              -e DB_PASSWORD=${{ secrets.DB_PASSWORD }} \
              -e DB_NAME=${{ secrets.DB_NAME }} \
              -e GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }} \
              -e PORT=3111 \
              -v /path/to/logs:/app/logs \
              news-monitor:latest
            
            # 验证
            sleep 5
            docker ps | grep news-monitor
            echo "✅ Deployment completed at $(date)"
